<!DOCTYPE html>
<html lang="zh" data-hairline="true" data-android="true" data-theme="light">
{% include 'question/head_mobile.html' %}
<body class="Mobile-body">
<div id="root">
<div class="App">
<div class="LoadingBar"></div>

<div>
{% include 'question/header_mobile.html' %}
</div>

<main role="main" class="App-main" data-module="mytopic" data-dfs-main='{"logged":"{{logged}}","user_id":"{{user.id}}","user_name":"{{user.first_name}}","user_avatar":"{{user.userprofile.avatar}}"}'>

<div id="mytopic">

{% ifequal logged 'true' %}
<div class="Card">
<div class="Card-header">
<div class="Card-headerText">
<a id="myfollow" target="_blank" href="">已关注的话题</a> 
</div>
</div>
<div class="Card-section">
{% if mytopic_list %}
{% for topic in mytopic_list %}
<div class="Tag FollowedTopic 1QuestionTopic" data-topic-id="{{ topic.id }}">
<span class="Tag-content">
<a class="1TopicLink" href="/topic/{{ topic.id }}">{{ topic.name }}</a>
</span>
</div>
{% endfor %}
{% endif %} 
</div>  
</div>
{% endifequal %}

<div class="Card">
<div class="Card-header">
<div class="Card-headerText">
全部的话题
</div>
</div>
<div class="List">
<div id="feedArea" class="">
<!--<div class="List-item SearchItem">-->
</div>
</div>
</div>

<!--<button class="OpenInAppButton OpenInApp is-shown">App 内打开</button>-->

</div>
</main>

</div>
</div>

<!-- 提问（Modal） -->
<div class="modal fade" id="askModal" tabindex="-1" role="dialog" aria-labelledby="askModalLabel" aria-hidden="true">
	<div class="modal-dialog askmodal">
        <div class="Modal-inner">
            <h3 class="Modal-title" id="askModalLabel">写下你的问题</h3>
            <div class="Modal-subtitle">描述精确的问题更易得到解答</div>
                <div class="Modal-content">
                    <div class="QuestionAsk">
                        <form method="post" action="/question/" id="form_ask">
                        {% csrf_token %}            
                            <div class="QuestionAsk-section">
                                <div class="QuestionAsk-title">
                                        <div class="Input-wrapper Input-wrapper--spread Input-wrapper--multiline Input-wrapper--large">
                                        <textarea required="" name="title" rows="2" autocomplete="off" role="combobox" aria-expanded="false" aria-autocomplete="list" aria-activedescendant="AutoComplet-64372-3800-0" id="Popover-64372-42711-toggle" aria-haspopup="true" aria-owns="Popover-64372-42711-content" class="Input" placeholder="问题标题"></textarea>
                                        </div>
                                </div>
                            </div>
            
                            <div class="QuestionAsk-section">
                                <div class="TagInput TagInput--empty">
                                            <select id="topics_select" name="topics_selected" class="selectpicker show-menu-arrow form-control" multiple data-live-search="true" data-max-options="5" data-style="Input-wrapper Input-wrapper--spread Input-wrapper--large" title="添加话题"></select>
                                </div>
                            </div>

                            <input id="hide_for_submit" type="hidden" name="topics" value="null123">
                
                            <div class="QuestionAsk-section QuestionAsk-DetailSection">问题描述（可选）:<textarea id="summernote_question" name="detail" 1rows="5" 1cols="70" 1maxlength="160"></textarea>              
                            </div>
                           
                            <div class="ModalButtonGroup QuestionAsk-buttonGroup ModalButtonGroup--vertical">
                                <button class="1Button 1Button--primary 1Button--green btn btn-success" type="submit" form="form_ask">提交问题</button>
                            </div>
                        </form>
                    </div>
                </div>
		</div>        
        <button data-dismiss="modal" aria-hidden="true" class="Button Modal-closeButton Button--plain close" style="right:0px;" aria-label="关闭" type="button">
        <svg class="Zi Zi--Close Modal-closeIcon" fill="currentColor" viewBox="0 0 24 24" width="24" height="24"><path d="M13.486 12l5.208-5.207a1.048 1.048 0 0 0-.006-1.483 1.046 1.046 0 0 0-1.482-.005L12 10.514 6.793 5.305a1.048 1.048 0 0 0-1.483.005 1.046 1.046 0 0 0-.005 1.483L10.514 12l-5.208 5.207a1.048 1.048 0 0 0 .006 1.483 1.046 1.046 0 0 0 1.482.005L12 13.486l5.207 5.208a1.048 1.048 0 0 0 1.483-.006 1.046 1.046 0 0 0 .005-1.482L13.486 12z" fill-rule="evenodd"></path></svg></button>        
	</div>
</div>
<script>
function followTopics()
{
    $("a[name='follow']").off("click");
    $("a[name='follow']").on("click",function(){
        var element=$(this);
        var topic_id=element.attr("data-topic-id");
        if("true"==element.attr("data-followed"))
        {
            $.post("/ajax/topic_follow/0/"+topic_id+"/",function(ret){
                if("fail"!=ret)
                {
                    element.removeClass("zg-unfollow").addClass("zg-follow").text("关注");
                    element.attr("data-followed","false");
                    //updateValue("topic-followed",ret);
                }
            }); 
        }
        else
        {
            $.post("/ajax/topic_follow/1/"+topic_id+"/",function(ret){
                if("fail"!=ret)
                {
                    element.removeClass("zg-follow").addClass("zg-unfollow").text("取消关注");
                    element.attr("data-followed","true");
                    //update_value("topic-followed",ret);
                }
            });  
        }
    });
}
function appendTopicElement(ret)
{
    for( var i in ret)
    {
        var topic_id=ret[i][0];
        var topic_name=ret[i][1];
        var topic_avatar=ret[i][2];
        var topic_detail=ret[i][3];
        var topic_question_nums=ret[i][4];
        var topic_follower_nums=ret[i][5];
        var topic_pub_date=ret[i][6];
        var topic_followed=ret[i][7];
        
        if(topic_followed)
            var follow_button_data='<button class="Button Button--grey FollowButton" type="button" data-follow-type="topic" data-topic-id="'+topic_id+'" data-followed="true">已关注</button>';
        else
            var follow_button_data='<button class="Button Button--blue FollowButton" type="button" data-follow-type="topic" data-topic-id="'+topic_id+'" data-followed="false">关注话题</button>';
        
        var data='<div class="List-item">\
                    <div class="ContentItem">\
                    <div class="ContentItem-main">\
                    <div class="ContentItem-image">\
                    <span class="TopicLink TopicItem-avatar">\
                    <a class="TopicLink-link" target="_blank" href="/topic/'+topic_id+'">\
                    <img class="Avatar Avatar--large TopicLink-avatar" width="60" height="60" src="'+topic_avatar+'"  alt="'+topic_name+'" data-author-id="'+topic_id+'" data-toggle="popover" data-placement="bottom" data-trigger="manual" data-content="null" data-html="true">\
                    </a>\
                    </span>\
                    </div>\
                    <div class="ContentItem-head">\
                    <h2 class="ContentItem-title">\
                    <div class="TopicItem-title">\
                    <span class="TopicLink TopicItem-name">\
                    <a class="TopicLink-link" target="_blank" href="/er/'+topic_id+'"><span class="RichText">'+topic_name+'</span></a>\
                    </span>\
                    </div>\
                    </h2>\
                    <div class="ContentItem-meta">\
                    <div>\
                    <div class="ContentItem-status">\
                    <div class="ContentItem-statusItem">'+topic_detail+'</div>\
                    </div>\
                    </div>\
                    </div>\
                    </div>\
                    <div class="ContentItem-extra">'+follow_button_data+'</div>\
                    </div>\
                    </div>\
                    </div>\
                    ';
        $("#feedArea").append(data);
    }
} 
function getMoreData() {
    var nums=g_last_getmoredata_index;//$('.Setting-item').length;
    var order=1;//pub_date
    var start=nums;
    var end=start+STEP*2;
    var bIsGetAll=0;
    $.get('/ajax/topics/'+bIsGetAll+'/'+start+'/'+end+'/',function(ret){
        if("fail"!=ret)
        {
            appendTopicElement(ret); 
            followTopics();            
            checkSets();
            g_last_getmoredata_index+=STEP*2;
        }
        setLockScrollMoreData("false");
    });
} 
function initElement()
{
    if("true"==g_logged)
        $("#myfollow").attr("href","/er/"+g_user_id+"/following/topics/");
}
function initData()
{
    g_last_getmoredata_index=0;
	var str_main_data=$("main").attr("data-dfs-main");
	console.log(str_main_data);
	var main_data=JSON.parse(str_main_data);//str_main_data.parseJSON();
	g_logged=main_data.logged;
    if("true"==g_logged)
    {
        g_user_id=main_data.user_id;
        g_user_name=main_data.user_name;
        g_user_avatar=main_data.user_avatar;
    }	
} 
function init()
{
    initData();
    initElement();
    getMoreData();
    checkSets();
    //appendLetterModal();
}
</script>
</body>
</html>